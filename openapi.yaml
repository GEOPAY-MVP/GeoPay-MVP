openapi: 3.0.3
info:
  title: GeoPay API
  description: RESTful API contract for the GeoPay MVP backend.
  version: 1.0.0
  contact:
    name: GeoPay Private Limited

servers:
  - url: /api/v1

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

security:
  - bearerAuth: []

paths:
  # ========================
  # User Authentication
  # ========================
  /users/register:
    post:
      summary: Register user (Step 1: email + password)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                password:
                  type: string
              required:
                - email
                - password
      responses:
        '201':
          description: Registration started
          content:
            application/json:
              example:
                message: "Registration started. Please upload CNIC."
        '400':
          description: Invalid email/password format
        '409':
          description: Email already registered

  /users/register-cnic:
    post:
      summary: Upload CNIC (Step 2)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email:
                  type: string
                cnic_image:
                  type: string
                  format: byte
              required:
                - email
                - cnic_image
      responses:
        '201':
          description: CNIC captured
          content:
            application/json:
              schema:
                type: object
                properties:
                  user_id:
                    type: string
                    format: uuid
                  full_name:
                    type: string
                  date_of_birth:
                    type: string
                    format: date
                  kyc_status:
                    type: string
                    enum: [pending, verified]
                  message:
                    type: string
        '400':
          description: Invalid CNIC image
        '409':
          description: CNIC already registered

  /users/verify-biometric:
    post:
      summary: Simulate biometric verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                  format: uuid
                biometric_token:
                  type: string
              required:
                - user_id
                - biometric_token
      responses:
        '200':
          description: Biometric verified
          content:
            application/json:
              example:
                user_id: "uuid"
                kyc_status: "verified"
                message: "Biometric verified successfully."
        '400':
          description: Invalid biometric token
        '401':
          description: Unauthorized session

  /users/login:
    post:
      summary: Login with email/phone + password/PIN
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                email_or_phone:
                  type: string
                password_or_pin:
                  type: string
              required:
                - email_or_phone
                - password_or_pin
      responses:
        '200':
          description: Successful login
          content:
            application/json:
              example:
                user_id: "uuid"
                token: "jwt"
                last_login_at: "timestamp"
        '401':
          description: Invalid credentials

  /users/send-otp:
    post:
      summary: Send OTP for login or device verification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                user_id:
                  type: string
                  format: uuid
                channel:
                  type: string
                  enum: [email, phone]
              required:
                - user_id
                - channel
      responses:
        '200':
          description: OTP sent
          content:
            application/json:
              example:
                message: "OTP sent successfully."
        '400':
          description: Invalid channel

  /devices/register:
    post:
      summary: Register device to user
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                device_fingerprint:
                  type: string
                os_type:
                  type: string
                otp:
                  type: string
              required:
                - device_fingerprint
                - os_type
                - otp
      responses:
        '201':
          description: Device registered
          content:
            application/json:
              example:
                device_id: "uuid"
                status: "active"
        '400':
          description: Invalid OTP
        '409':
          description: Device already registered

  /users/me:
    get:
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              example:
                user_id: "uuid"
                full_name: "string"
                email: "string"
                phone_number: "string"
                cnic: "string"
                date_of_birth: "string"
                kyc_status: "string"
                registered_at: "timestamp"
                last_login_at: "timestamp"
                status: "string"

  # ========================
  # Wallet Management
  # ========================
  /wallets:
    get:
      summary: Get wallet details
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Wallet details
          content:
            application/json:
              example:
                wallet_id: "uuid"
                available_balance: 5000
                pending_balance: 200
                currency_code: "PKR"
                status: "active"
                created_at: "timestamp"
                updated_at: "timestamp"
        '404':
          description: Wallet not found

  /wallets/transactions:
    get:
      summary: Get transaction history
      security:
        - bearerAuth: []
      parameters:
        - in: query
          name: search
          schema:
            type: string
        - in: query
          name: start_date
          schema:
            type: string
            format: date
        - in: query
          name: end_date
          schema:
            type: string
            format: date
        - in: query
          name: type
          schema:
            type: string
        - in: query
          name: page
          schema:
            type: integer
        - in: query
          name: limit
          schema:
            type: integer
      responses:
        '200':
          description: Transaction list
          content:
            application/json:
              example:
                transactions:
                  - transaction_id: "uuid"
                    transaction_type: "string"
                    amount: 100
                    status: "completed"
                    created_at: "timestamp"
                    completed_at: "timestamp"
                total: 1
                page: 1

  # ========================
  # Payment & Transfers
  # ========================
  /transactions/p2p:
    post:
      summary: Initiate P2P transfer
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                receiver_phone_or_cnic:
                  type: string
                amount:
                  type: number
                description:
                  type: string
              required:
                - receiver_phone_or_cnic
                - amount
      responses:
        '201':
          description: Transfer successful
          content:
            application/json:
              example:
                transaction_id: "uuid"
                status: "completed"
                completed_at: "timestamp"
        '400':
          description: Insufficient balance
        '404':
          description: Receiver not found
